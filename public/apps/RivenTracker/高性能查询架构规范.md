# RivenTracker 高性能查询架构与 API 规范 (V3.0)

## 1. 查询架构概述

为了在 Cloudflare 免费额度下实现极致的性能，系统采用了 **“三级分流”** 查询架构：

| 层级 | 存储介质 | 适用场景 | 响应耗时 | D1 压力 |
| :--- | :--- | :--- | :--- | :--- |
| **第一级：内存拦截** | **Durable Object 内存** | 最近 24h 的原始数据 (`mode=raw`) 或 1h 聚合 | **~5ms** | 零 |
| **第二级：趋势缓存** | **Cloudflare KV** | 7天/30天趋势的重复请求 | **~15ms** | 极低 |
| **第三级：数据库聚合** | **D1 (SQLite) SQL** | 首次请求的长周期趋势图 | **~150ms** | 显著优化 |

---

## 2. 核心 API 定义

### 2.1 获取底价趋势 (`/api/RivenTracker/bottom-trend`)

**核心变更**：`range` 参数现在代表 **“聚合区间（颗粒度）”**，而非单纯的时间跨度。

#### 请求参数：
*   `weapon` (必填): 武器 slug（如 `soma`）。
*   `mode` (可选): 
    *   `raw`: **原始模式**。无视 `range`，固定返回 DO 内存中的 **最近 100 条** 原始采样（覆盖热门武器约 33 小时）。
    *   `aggregated` (默认): **聚合模式**。根据 `range` 进行降采样。
*   `range` (可选):
    *   `1h`: 按 **1 小时** 聚合（展示最近 24 小时）。
    *   `4h`: 按 **4 小时** 聚合（展示最近 7 天）。
    *   `1d`: 按 **1 天** 聚合（展示最近 30 天）。

#### 后端路由逻辑：
1.  **命中 DO 内存**：如果 `mode=raw` 或 `range=1h`，且 DO 内存中数据点充足（>=10条），Worker 直接请求 DO 内存，计算结果并返回。
2.  **命中 KV 缓存**：若未命中 DO，检查 KV 是否有对应参数的缓存。
    *   `range=1h & mode=aggregated`: 缓存 **1 小时**（匹配聚合步长）。
    *   `range=1h & mode=raw`: 缓存 **10 分钟**（保持原始灵敏度）。
    *   `7d / 30d`: 缓存 **4 小时**。
3.  **D1 SQL 聚合**：若缓存失效，D1 执行 `GROUP BY` 聚合查询，Worker 使用 `ctx.waitUntil` 异步写入 KV 并返回。

---

### 2.2 当前底价快照 (`/api/RivenTracker/bottom-now`)

#### 请求参数：
*   `weapon` (必填): 武器 slug。

#### 优化机制：
*   **Bundle 模式**：优先从 KV 的 `riven:latest:pc`（包含 400+ 武器的大 JSON）中 O(1) 提取。
*   **缓存头**：浏览器端强制缓存 1 分钟，减少对边缘节点的无效请求。

---

## 3. 前端适配指南 (Implementation)

前端在发起请求时，请参考下表进行参数映射，以获得最佳性能：

| UI 功能按钮 | `mode` | `range` | 说明 |
| :--- | :--- | :--- | :--- |
| **实时 (24h)** | `raw` | (可不传) | 返回最近 100 条原始点，最细腻。 |
| **24h 聚合** | `aggregated` | `1h` | 24 个小时点，由 DO 内存计算。 |
| **7 天趋势** | `aggregated` | `4h` | 约 42 个点，由 D1 SQL 聚合提供。 |
| **30 天趋势** | `aggregated` | `1d` | 30 个点，由 D1 SQL 聚合提供。 |

---

## 4. 性能保障记录

### 4.1 SQL 级别聚合 (SQL-Agg)
*   **优化前**：Worker 拉取几千行数据在内存中循环聚合 $\rightarrow$ 耗时 500ms+，易内存溢出。
*   **优化后**：D1 数据库层完成 `AVG`/`COUNT` 计算 $\rightarrow$ 耗时 <100ms，传输载荷缩减 99%。

### 4.2 KV 写入保护 (Zero-Cost Cache)
*   **长周期缓存**：针对 7d/30d 趋势，KV 缓存有效期设为 **4 小时**。
*   **结果**：即使有数万用户访问，针对同一个武器的 30 天趋势，每天仅消耗 **6 次** KV 写入额度（限额 1000 次/天）。

### 4.3 强一致性采样 (DO-Lock)
*   **游标管理**：不再依赖 KV，由 DO 内存维护 `cursorHot/Cold`。
*   **结果**：彻底杜绝了在高频采样下可能出现的“跳过武器”或“重复采样”问题。

---
**维护者**: AI Coding Agent  
**更新日期**: 2026-01-09 (架构 V3.0)

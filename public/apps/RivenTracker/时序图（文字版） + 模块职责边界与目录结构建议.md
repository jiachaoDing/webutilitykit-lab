# RivenTracker 架构说明 (V3.0 - DO 协同版)

## 1) 组件交互时序图（文字版）

### 1.1 价格采样与持久化时序（每分钟）

参与者：`Cron` → `SamplingService` → `RivenCoordinatorDO` → `WarframeMarket v1` → `D1`

1.  **任务启动**：`Cron` 每分钟触发一次。
2.  **获取任务**：`SamplingService` 调用 `DO /next-batch?hotBatchSize=X&coldBatchSize=Y`。
3.  **DO 计算游标**：
    *   `DO` 根据内存中的 `cursorHot/Cold` 和武器名单，计算出本轮应采样的 `slugs`。
    *   `DO` 更新并持久化游标到 `state.storage`，返回 `slugs` 给 Worker。
4.  **外部采样**：`SamplingService` 并发调用 `WFM v1 API` 获取拍卖数据。
5.  **计算底价**：调用 `BottomPriceCalculator` 得到本轮的 `samples[]` (Ticks)。
6.  **结果交回**：`SamplingService` 调用 `DO /append-results` 提交结果。
7.  **原子写入与更新**：
    *   `DO` 调用 `D1` 执行批量 `UPSERT`（历史表）。
    *   `DO` 更新内存中的 `latestBySlug` 快照，标记状态为 `dirty`。
8.  **结束**。

---

### 1.2 快照同步时序（每 5 分钟）

参与者：`Cron` → `RivenCoordinatorDO` → `KV`

1.  **触发同步**：`Cron` 检测到分钟数为 5 的倍数，调用 `DO /sync-snapshot`。
2.  **合并写入**：
    *   `DO` 检查 `dirty` 标记。
    *   若有更新，将内存中所有武器的最新 Ticks 序列化为一个大 JSON。
    *   一次性写入 `KV` 的 `riven:latest:pc`。
3.  **状态清空**：`DO` 清除 `dirty` 标记。

---

### 1.3 前端查询时序（秒开）

参与者：`Client` → `Worker` → `KV` → `D1`

1.  **请求**：`Client → GET /api/RivenTracker/bottom-now?weapon=...`
2.  **KV 优先**：`Worker` 读取 `KV(riven:latest:pc)` 并从中提取目标武器的 JSON。
3.  **回退路径**：若 KV 缺失或版本过旧，`Worker` 降级查询 `D1` 历史表获取最新一条。
4.  **响应**：秒级返回给 Client。

---

## 2) 模块职责边界（DO 核心化）

### 2.1 协调层：Durable Object (RivenCoordinatorDO)
*   **职责**：状态真理中心。
*   **功能**：管理采样游标、维护内存快照、管控 D1 批量写入入口、负责 KV 快照同步。
*   **意义**：消除 KV 最终一致性带来的游标冲突，极大降低 KV 写入频率。

### 2.2 采样层：SamplingService (Worker)
*   **职责**：无状态执行工人。
*   **功能**：向 DO 要任务、执行网络爬虫、运行底价算法、将结果汇报给 DO。

### 2.3 领域层：BottomPriceCalculator & Sharding
*   **职责**：纯粹业务逻辑。
*   **功能**：异常价格剔除、采样时间窗口对齐（window_ts）。

### 2.4 存储层：Repository
*   **职责**：数据持久化适配。
*   **TickRepo**：负责 D1 中 `riven_bottom_tick` 表的读写。
*   **TrackedRepo**：负责武器名单（Hot/Cold）的元数据管理。

---

## 3) 目录结构建议

```
src/
  index.ts                  # 统一入口：导出 DO 类，分发 API 与 Scheduled 事件
  apps/RivenTracker/
    RivenCoordinatorDO.ts   # 【核心】状态协调器，处理游标与 D1 写入分发
    jobs/
      index.ts              # 定时任务逻辑：调用 DO 接口
    routes/
      index.ts              # Hono 路由：/bottom-now, /bottom-trend 等
    services/
      SamplingService.ts    # 采样业务逻辑：WFM 爬取 + 计算
      TrendService.ts       # 查询业务逻辑：KV 优先读取策略
    repos/
      TickRepo.ts           # D1 价格表访问
      TrackedRepo.ts        # D1 追踪名单访问
      WeaponRepo.ts         # D1 武器字典访问
    clients/
      WfmV1Client.ts        # WFM API 适配
    domain/
      BottomPriceCalculator.ts # 算法：异常剔除与加权底价
      types.ts              # 统一数据结构 (Tick, Auction)
```

---

## 4) 采样“窗口与游标”规范

*   **时间窗口**：所有 Tick 强制对齐至 `floor(now, 1 minute)`，确保趋势图连续。
*   **游标持久化**：游标存储在 DO 的 `state.storage` 中，随 Worker 部署自动持久化。
*   **分层逻辑**：
    *   **Hot**：高频采样（如每 10-20 分钟一轮）。
    *   **Cold**：低频采样（如每 1-2 小时一轮）。
    *   **权重控制**：通过 Cron 传入不同的 `batchSize` 参数由 DO 统一调度。

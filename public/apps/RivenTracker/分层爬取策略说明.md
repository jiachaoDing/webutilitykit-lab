# Riven Tracker åˆ†å±‚çˆ¬å–ç­–ç•¥è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æ–°çš„åˆ†å±‚çˆ¬å–ç­–ç•¥å°† 414 æŠŠæ­¦å™¨åˆ†ä¸º**çƒ­é—¨æ­¦å™¨**å’Œ**å†·é—¨æ­¦å™¨**ä¸¤ä¸ªå±‚çº§ï¼Œä¸åŒå±‚çº§ä½¿ç”¨ä¸åŒçš„çˆ¬å–é¢‘ç‡ï¼Œç¡®ä¿çƒ­é—¨æ­¦å™¨æ›´æ–°æ›´åŠæ—¶ï¼ŒåŒæ—¶å…¼é¡¾æ‰€æœ‰æ­¦å™¨çš„è¦†ç›–ã€‚

---

## ğŸ¯ åˆ†å±‚è§„åˆ™

### æ­¦å™¨åˆ†å±‚ä¾æ®
- **çƒ­é—¨æ­¦å™¨ï¼ˆHotï¼‰**ï¼šåŸºäºæœ€è¿‘ **7 å¤©**çš„ `bottom_price` å¹³å‡å€¼æ’åºï¼Œ**å‰ 50 å**
- **å†·é—¨æ­¦å™¨ï¼ˆColdï¼‰**ï¼šå…¶ä½™æ­¦å™¨

### åˆ†å±‚æ›´æ–°é¢‘ç‡
- **æ¯å¤© UTC 03:00** è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡åˆ†å±‚
- åœ¨å­—å…¸åŒæ­¥ä»»åŠ¡ï¼ˆ`sync_rivens`ï¼‰æˆåŠŸåç«‹å³æ‰§è¡Œ
- åŸºäºå®æ—¶é‡‡æ ·æ•°æ®ï¼ŒåŠ¨æ€è°ƒæ•´æ­¦å™¨åˆ†å±‚

---

## âš¡ é‡‡æ ·ç­–ç•¥

### é‡‡æ ·æ¨¡å¼ï¼ˆå¥‡å¶åˆ†é’Ÿäº¤æ›¿ï¼‰
- **å¥‡æ•°åˆ†é’Ÿ**ï¼ˆ1, 3, 5, 7...ï¼‰ï¼šé‡‡æ · **3 æŠŠçƒ­é—¨**æ­¦å™¨
- **å¶æ•°åˆ†é’Ÿ**ï¼ˆ2, 4, 6, 8...ï¼‰ï¼šé‡‡æ · **2 æŠŠçƒ­é—¨ + 1 æŠŠå†·é—¨**æ­¦å™¨
- **æ€»è®¡**ï¼šæ¯åˆ†é’Ÿé‡‡æ · **3 æŠŠæ­¦å™¨**ï¼ˆä¿æŒåŸæœ‰é¢‘ç‡ï¼‰

### è¦†ç›–å‘¨æœŸ
- **çƒ­é—¨æ­¦å™¨**ï¼ˆ50 æŠŠï¼‰ï¼š**20 åˆ†é’Ÿ**å®Œæˆä¸€è½®
  - è®¡ç®—ï¼š50 Ã· (3 + 2) Ã— 2 = 20 åˆ†é’Ÿ
- **å†·é—¨æ­¦å™¨**ï¼ˆ364 æŠŠï¼‰ï¼š**728 åˆ†é’Ÿ** â‰ˆ **12 å°æ—¶**å®Œæˆä¸€è½®
  - è®¡ç®—ï¼š364 Ã— 2 åˆ†é’Ÿ = 728 åˆ†é’Ÿ

### ä¼˜åŠ¿
ç›¸æ¯”åŸæ–¹æ¡ˆï¼ˆæ¯åˆ†é’Ÿ 3 æŠŠï¼Œ138 åˆ†é’Ÿä¸€è½®å…¨éƒ¨æ­¦å™¨ï¼‰ï¼Œæ–°æ–¹æ¡ˆï¼š
- âœ… çƒ­é—¨æ­¦å™¨æ›´æ–°é¢‘ç‡æå‡ **6.9 å€**ï¼ˆä» 138 åˆ†é’Ÿ â†’ 20 åˆ†é’Ÿï¼‰
- âœ… å†·é—¨æ­¦å™¨æ›´æ–°é¢‘ç‡åˆç†ï¼ˆ12 å°æ—¶ï¼Œä»·æ ¼å˜åŒ–ä¸é¢‘ç¹ï¼‰
- âœ… **API è°ƒç”¨é¢‘ç‡ä¸å˜**ï¼ˆä¿æŒ 3 æŠŠ/åˆ†é’Ÿï¼‰
- âœ… ç¬¦åˆç”¨æˆ·å®é™…éœ€æ±‚ï¼ˆçƒ­é—¨æ­¦å™¨ä»·æ ¼å˜åŒ–å¿«ï¼Œéœ€è¦æ›´é¢‘ç¹ç›‘æ§ï¼‰
- âœ… å®ç°ç®€å•ä¼˜é›…ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤

---

## ğŸ—ï¸ æŠ€æœ¯å®ç°

### 1. æ•°æ®åº“è¿ç§»
**æ–‡ä»¶**: `migrations/0005_add_weapon_tier.sql`

```sql
-- æ·»åŠ  tier å­—æ®µç”¨äºåŒºåˆ†çƒ­é—¨/å†·é—¨æ­¦å™¨
ALTER TABLE tracked_weapon ADD COLUMN tier TEXT DEFAULT 'cold';

-- åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_tracked_tier 
ON tracked_weapon(tier, enabled, priority DESC);
```

### 2. åŒæ¸¸æ ‡ç³»ç»Ÿ
**æ–‡ä»¶**: `src/apps/RivenTracker/repos/SamplingCursorRepo.ts`

- **`cursorHot`**: çƒ­é—¨æ­¦å™¨æ¸¸æ ‡ï¼ˆç‹¬ç«‹è¿½è¸ªå‰ 50 åæ­¦å™¨ï¼‰
- **`cursorCold`**: å†·é—¨æ­¦å™¨æ¸¸æ ‡ï¼ˆç‹¬ç«‹è¿½è¸ªå…¶ä½™æ­¦å™¨ï¼‰
- ä¸¤ä¸ªæ¸¸æ ‡ç‹¬ç«‹æ¨è¿›ï¼Œäº’ä¸å½±å“

### 3. åˆ†å±‚é‡‡æ ·æœåŠ¡
**æ–‡ä»¶**: `src/apps/RivenTracker/services/SamplingService.ts`

æ–°å¢æ–¹æ³• `runTieredBatch()`ï¼š
- å¹¶è¡Œè·å–çƒ­é—¨å’Œå†·é—¨æ­¦å™¨åˆ—è¡¨
- æŒ‰é…ç½®æ¯”ä¾‹ï¼ˆ5:1ï¼‰æ„å»ºé‡‡æ ·è®¡åˆ’
- é¡ºåºæ‰§è¡Œé‡‡æ ·ï¼Œåˆ†åˆ«æ›´æ–°ä¸¤ä¸ªæ¸¸æ ‡

### 4. åˆ†å±‚æ›´æ–°æœåŠ¡
**æ–‡ä»¶**: `src/apps/RivenTracker/services/TierUpdateService.ts`

åŠŸèƒ½ï¼š
- æŸ¥è¯¢æœ€è¿‘ 7 å¤©çš„ä»·æ ¼æ•°æ®
- è®¡ç®—æ¯ä¸ªæ­¦å™¨çš„å¹³å‡ `bottom_price`
- æŒ‰ä»·æ ¼é™åºæ’åºï¼Œå‰ 50 åæ ‡è®°ä¸º `hot`ï¼Œå…¶ä½™æ ‡è®°ä¸º `cold`
- æ‰¹é‡æ›´æ–° `tracked_weapon` è¡¨çš„ `tier` å­—æ®µ

### 5. å®šæ—¶ä»»åŠ¡é›†æˆ
**æ–‡ä»¶**: `src/apps/RivenTracker/jobs/index.ts`

#### æ¯åˆ†é’Ÿä»»åŠ¡ï¼ˆé‡‡æ ·ï¼‰
```javascript
// æ ¹æ®å¥‡å¶åˆ†é’Ÿå†³å®šé‡‡æ ·ç­–ç•¥
const currentMinute = now.getMinutes();
const isEvenMinute = currentMinute % 2 === 0;

// å¥‡æ•°åˆ†é’Ÿï¼š3 æŠŠçƒ­é—¨ï¼Œ0 æŠŠå†·é—¨
// å¶æ•°åˆ†é’Ÿï¼š2 æŠŠçƒ­é—¨ï¼Œ1 æŠŠå†·é—¨
const hotBatchSize = isEvenMinute ? 2 : 3;
const coldBatchSize = isEvenMinute ? 1 : 0;

const stats = await samplingService.runTieredBatch(
  cursorHot, 
  cursorCold, 
  hotBatchSize,
  coldBatchSize,
  windowTs, 
  { timeBudgetMs: 20000 }
);

// æ›´æ–°åŒæ¸¸æ ‡
await cursorRepo.setTiered(
  stats.cursor_hot_after, 
  stats.cursor_cold_after
);
```

#### æ¯æ—¥ä»»åŠ¡ï¼ˆUTC 03:00ï¼‰
```javascript
// 1. åŒæ­¥å­—å…¸
await syncService.syncRivens();

// 2. æ›´æ–°åˆ†å±‚ï¼ˆåŸºäºæœ€è¿‘ 7 å¤©ä»·æ ¼ç»Ÿè®¡ï¼‰
const tierResult = await tierUpdateService.updateTiers(7, 50);
// è¾“å‡ºï¼š{ hot_count: 50, cold_count: 364, ... }
```

---

## ğŸ”§ é…ç½®å‚æ•°

### ç¯å¢ƒå˜é‡
å¯é€šè¿‡ `wrangler.toml` æˆ– Cloudflare Dashboard è®¾ç½®ï¼š

```toml
[vars]
HOT_BATCH_SIZE_ODD = "3"   # å¥‡æ•°åˆ†é’Ÿï¼šçƒ­é—¨æ­¦å™¨é‡‡æ ·æ•°é‡
HOT_BATCH_SIZE_EVEN = "2"  # å¶æ•°åˆ†é’Ÿï¼šçƒ­é—¨æ­¦å™¨é‡‡æ ·æ•°é‡
COLD_BATCH_SIZE = "1"      # å¶æ•°åˆ†é’Ÿï¼šå†·é—¨æ­¦å™¨é‡‡æ ·æ•°é‡
```

### åˆ†å±‚å‚æ•°
åœ¨ `TierUpdateService.updateTiers()` ä¸­å¯è°ƒæ•´ï¼š
- `days`: ç»Ÿè®¡å¤©æ•°ï¼ˆé»˜è®¤ 7 å¤©ï¼‰
- `hotThreshold`: çƒ­é—¨æ­¦å™¨æ•°é‡é˜ˆå€¼ï¼ˆé»˜è®¤ 50ï¼‰

---

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### Job Run è®°å½•
æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œéƒ½ä¼šè®°å½•åˆ° `job_run` è¡¨ï¼š

#### é‡‡æ ·ä»»åŠ¡ï¼ˆå¥‡æ•°åˆ†é’Ÿï¼‰
```json
{
  "job_name": "sample_tiered",
  "detail": {
    "minute": 1,
    "cycle": "odd",
    "tier_stats": {
      "hot": { "total": 50, "processed": 3 },
      "cold": { "total": 364, "processed": 0 }
    },
    "cursor_hot": { "before": 0, "after": 3 },
    "cursor_cold": { "before": 0, "after": 0 },
    "ok": 3,
    "no_data": 0,
    "error": 0
  }
}
```

#### é‡‡æ ·ä»»åŠ¡ï¼ˆå¶æ•°åˆ†é’Ÿï¼‰
```json
{
  "job_name": "sample_tiered",
  "detail": {
    "minute": 2,
    "cycle": "even",
    "tier_stats": {
      "hot": { "total": 50, "processed": 2 },
      "cold": { "total": 364, "processed": 1 }
    },
    "cursor_hot": { "before": 3, "after": 5 },
    "cursor_cold": { "before": 0, "after": 1 },
    "ok": 3,
    "no_data": 0,
    "error": 0
  }
}
```

#### åˆ†å±‚æ›´æ–°ä»»åŠ¡
```json
{
  "job_name": "update_weapon_tiers",
  "detail": {
    "total_tracked": 414,
    "hot_count": 50,
    "cold_count": 364,
    "stats_days": 7,
    "top_hot_weapons": ["magistar", "soma", ...]
  }
}
```

### æ—¥å¿—è¾“å‡º
```
[TierUpdate] Starting weapon tier update...
[TierUpdate] Updated weapon tiers: 50 hot, 364 cold
[TierUpdate] Success: 50 hot, 364 cold
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. æ‰§è¡Œæ•°æ®åº“è¿ç§»
```bash
# æœ¬åœ°å¼€å‘ç¯å¢ƒ
wrangler d1 execute DB --local --file=./migrations/0005_add_weapon_tier.sql

# ç”Ÿäº§ç¯å¢ƒ
wrangler d1 execute DB --remote --file=./migrations/0005_add_weapon_tier.sql
```

### 2. éƒ¨ç½²ä»£ç 
```bash
wrangler deploy
```

### 3. è§¦å‘é¦–æ¬¡åˆ†å±‚æ›´æ–°

#### æ–¹æ³• 1ï¼šé€šè¿‡ HTTP API æ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èï¼‰

éƒ¨ç½²åï¼Œé€šè¿‡ API ç«¯ç‚¹æ‰‹åŠ¨è§¦å‘åˆ†å±‚æ›´æ–°ï¼š

```bash
# æœ¬åœ°å¼€å‘ç¯å¢ƒï¼ˆä½¿ç”¨ wrangler devï¼‰
curl -X POST "http://localhost:8787/api/RivenTracker/debug/update-tiers?days=7&hotThreshold=50"

# ç”Ÿäº§ç¯å¢ƒ
curl -X POST "https://lab.webutilitykit.com/api/RivenTracker/debug/update-tiers?days=7&hotThreshold=50"
```

**å‚æ•°è¯´æ˜**ï¼š
- `days`: ç»Ÿè®¡æœ€è¿‘ N å¤©çš„ä»·æ ¼æ•°æ®ï¼ˆé»˜è®¤ 7ï¼‰
- `hotThreshold`: çƒ­é—¨æ­¦å™¨æ•°é‡é˜ˆå€¼ï¼ˆé»˜è®¤ 50ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "result": {
    "updated_at": "2026-01-07T12:34:56.789Z",
    "total_tracked": 414,
    "hot_count": 50,
    "cold_count": 364,
    "stats_days": 7,
    "top_hot_weapons": ["magistar", "soma", "rubico", ...]
  }
}
```

#### æ–¹æ³• 2ï¼šæŸ¥çœ‹å½“å‰åˆ†å±‚ç»Ÿè®¡

```bash
# æŸ¥çœ‹å½“å‰åˆ†å±‚çŠ¶æ€
curl "https://lab.webutilitykit.com/api/RivenTracker/debug/tier-stats"
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "stats": {
    "hot": 50,
    "cold": 364
  },
  "hot_weapons": ["magistar", "soma", "rubico", ...],
  "cold_weapons": ["cestra", "boltor", ...],
  "hot_count": 50,
  "cold_count": 364
}
```

#### æ–¹æ³• 3ï¼šé€šè¿‡ Cloudflare Dashboard æ‰‹åŠ¨è§¦å‘ Cron

1. ç™»å½• [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. è¿›å…¥ Workers & Pages â†’ é€‰æ‹©æ‚¨çš„ Worker
3. ç‚¹å‡» **Triggers** æ ‡ç­¾
4. æ‰¾åˆ° `0 3 * * *` Cron è§¦å‘å™¨
5. ç‚¹å‡» **Trigger** æŒ‰é’®æ‰‹åŠ¨æ‰§è¡Œ

#### æ–¹æ³• 4ï¼šç­‰å¾…è‡ªåŠ¨æ‰§è¡Œ

ç­‰å¾…æ¯æ—¥ UTC 03:00 è‡ªåŠ¨æ‰§è¡Œå­—å…¸åŒæ­¥å’Œåˆ†å±‚æ›´æ–°ä»»åŠ¡ã€‚

### 4. éªŒè¯åˆ†å±‚ç»“æœ
```sql
-- æŸ¥çœ‹åˆ†å±‚ç»Ÿè®¡
SELECT tier, COUNT(*) as count 
FROM tracked_weapon 
WHERE enabled = 1 
GROUP BY tier;

-- æŸ¥çœ‹çƒ­é—¨æ­¦å™¨åˆ—è¡¨
SELECT slug, tier 
FROM tracked_weapon 
WHERE tier = 'hot' AND enabled = 1 
ORDER BY priority DESC;
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ‰€æœ‰æ­¦å™¨éƒ½æ˜¯ cold
**åŸå› **ï¼šå°šæœªæ‰§è¡Œé¦–æ¬¡åˆ†å±‚æ›´æ–°  
**è§£å†³**ï¼šæ‰‹åŠ¨è§¦å‘ UTC 03:00 çš„ Cron ä»»åŠ¡ï¼Œæˆ–è°ƒç”¨ `TierUpdateService.updateTiers()`

### é—®é¢˜ï¼šåˆ†å±‚æ›´æ–°å¤±è´¥
**åŸå› **ï¼šä»·æ ¼æ•°æ®ä¸è¶³ï¼ˆæ–°ç³»ç»Ÿæˆ–æ•°æ®åº“ä¸ºç©ºï¼‰  
**è§£å†³**ï¼šç­‰å¾…é‡‡æ ·ä»»åŠ¡è¿è¡Œå‡ å¤©ç§¯ç´¯æ•°æ®åå†æ‰§è¡Œåˆ†å±‚æ›´æ–°

### é—®é¢˜ï¼šæ¸¸æ ‡æ²¡æœ‰æ›´æ–°
**åŸå› **ï¼šæ£€æŸ¥ `sampling_cursor_v2_tiered` æ˜¯å¦æ­£ç¡®å†™å…¥ `sync_state` è¡¨  
**è§£å†³**ï¼šæŸ¥è¯¢ `SELECT * FROM sync_state WHERE key = 'sampling_cursor_v2_tiered'`

---

## ğŸ“ˆ æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **åŠ¨æ€è°ƒæ•´çƒ­é—¨æ­¦å™¨é˜ˆå€¼**  
   æ ¹æ®æ€»æ­¦å™¨æ•°é‡è‡ªåŠ¨è°ƒæ•´ `hotThreshold`ï¼ˆå¦‚æ€»æ•°çš„ 10-15%ï¼‰

2. **å¤šå±‚çº§åˆ†å±‚**  
   å¼•å…¥ç¬¬ä¸‰å±‚çº§ï¼ˆå¦‚ "warm"ï¼‰ï¼Œå®ç°æ›´ç»†ç²’åº¦çš„é‡‡æ ·æ§åˆ¶

3. **åŠ æƒåˆ†å±‚ä¾æ®**  
   ç»¼åˆè€ƒè™‘ä»·æ ¼ã€æ´»è·ƒè®¢å•æ•°ã€ä»·æ ¼æ³¢åŠ¨ç‡ç­‰å¤šä¸ªæŒ‡æ ‡

4. **å‰ç«¯å¯è§†åŒ–**  
   åœ¨ Dashboard å±•ç¤ºæ­¦å™¨åˆ†å±‚ä¿¡æ¯å’Œæ›´æ–°å†å²

---

## ğŸ“ å˜æ›´æ—¥å¿—

### v1.0 (2026-01-07)
- âœ… åˆå§‹å®ç°åˆ†å±‚çˆ¬å–ç­–ç•¥
- âœ… æ”¯æŒåŒæ¸¸æ ‡ç³»ç»Ÿ
- âœ… å¥‡å¶åˆ†é’Ÿäº¤æ›¿é‡‡æ ·ï¼ˆ3 æŠŠ/åˆ†é’Ÿï¼Œä¿æŒåŸæœ‰é¢‘ç‡ï¼‰
- âœ… è‡ªåŠ¨åˆ†å±‚æ›´æ–°ï¼ˆæ¯æ—¥ UTC 03:00ï¼‰
- âœ… åŸºäº 7 å¤©ä»·æ ¼ç»Ÿè®¡åŠ¨æ€è°ƒæ•´åˆ†å±‚
- âœ… çƒ­é—¨æ­¦å™¨æ›´æ–°å‘¨æœŸï¼š20 åˆ†é’Ÿ
- âœ… å†·é—¨æ­¦å™¨æ›´æ–°å‘¨æœŸï¼š12 å°æ—¶

---

**ç»´æŠ¤è€…**: AI Coding Agent  
**æœ€åæ›´æ–°**: 2026-01-07


## ğŸ“Š æŸ¥è¯¢ job_run è¡¨çš„å¸¸ç”¨å‘½ä»¤

### 1ï¸âƒ£ æŸ¥çœ‹æœ€è¿‘çš„ä»»åŠ¡è®°å½•

```powershell
# æŸ¥çœ‹æœ€è¿‘ 10 æ¡ä»»åŠ¡è®°å½•
wrangler d1 execute DB --remote --command "SELECT id, job_name, started_at, finished_at, status FROM job_run ORDER BY started_at DESC LIMIT 10;"
```

---

### 2ï¸âƒ£ æŸ¥çœ‹é‡‡æ ·ä»»åŠ¡ï¼ˆåˆ†å±‚é‡‡æ ·ï¼‰

```powershell
# æŸ¥çœ‹æœ€è¿‘çš„åˆ†å±‚é‡‡æ ·ä»»åŠ¡
wrangler d1 execute DB --remote --command "SELECT started_at, finished_at, status, detail FROM job_run WHERE job_name='sample_tiered' ORDER BY started_at DESC LIMIT 10;"
```

**æŸ¥çœ‹æ¸¸æ ‡å˜åŒ–**ï¼š
```powershell
wrangler d1 execute DB --remote --command "SELECT started_at, json_extract(detail, '$.cycle') as cycle, json_extract(detail, '$.cursor_hot.before') as hot_before, json_extract(detail, '$.cursor_hot.after') as hot_after, json_extract(detail, '$.cursor_cold.before') as cold_before, json_extract(detail, '$.cursor_cold.after') as cold_after, json_extract(detail, '$.ok') as ok, json_extract(detail, '$.error') as error FROM job_run WHERE job_name='sample_tiered' ORDER BY started_at DESC LIMIT 15;"
```

---

### 3ï¸âƒ£ æŸ¥çœ‹åˆ†å±‚æ›´æ–°ä»»åŠ¡

```powershell
# æŸ¥çœ‹åˆ†å±‚æ›´æ–°ä»»åŠ¡è®°å½•
wrangler d1 execute DB --remote --command "SELECT started_at, finished_at, status, detail FROM job_run WHERE job_name='update_weapon_tiers' ORDER BY started_at DESC LIMIT 5;"
```

**æŸ¥çœ‹åˆ†å±‚ç»“æœ**ï¼š
```powershell
wrangler d1 execute DB --remote --command "SELECT started_at, json_extract(detail, '$.total_tracked') as total, json_extract(detail, '$.hot_count') as hot, json_extract(detail, '$.cold_count') as cold, json_extract(detail, '$.top_hot_weapons') as top_weapons FROM job_run WHERE job_name='update_weapon_tiers' ORDER BY started_at DESC LIMIT 5;"
```

---

### 4ï¸âƒ£ æŸ¥çœ‹å­—å…¸åŒæ­¥ä»»åŠ¡

```powershell
# æŸ¥çœ‹å­—å…¸åŒæ­¥ä»»åŠ¡
wrangler d1 execute DB --remote --command "SELECT started_at, finished_at, status, detail FROM job_run WHERE job_name='sync_rivens' ORDER BY started_at DESC LIMIT 5;"
```

---

### 5ï¸âƒ£ æŸ¥çœ‹å¤±è´¥çš„ä»»åŠ¡

```powershell
# æŸ¥çœ‹æ‰€æœ‰å¤±è´¥çš„ä»»åŠ¡
wrangler d1 execute DB --remote --command "SELECT job_name, started_at, finished_at, detail FROM job_run WHERE status='fail' ORDER BY started_at DESC LIMIT 20;"
```

---

### 6ï¸âƒ£ ç»Ÿè®¡ä»»åŠ¡æ‰§è¡Œæƒ…å†µ

```powershell
# ç»Ÿè®¡å„ç±»ä»»åŠ¡çš„æˆåŠŸ/å¤±è´¥æ¬¡æ•°
wrangler d1 execute DB --remote --command "SELECT job_name, status, COUNT(*) as count FROM job_run GROUP BY job_name, status ORDER BY job_name, status;"
```

---

### 7ï¸âƒ£ æŸ¥çœ‹ä»Šå¤©çš„ä»»åŠ¡è®°å½•

```powershell
# æŸ¥çœ‹ä»Šå¤©çš„æ‰€æœ‰ä»»åŠ¡ï¼ˆéœ€è¦æ›¿æ¢æ—¥æœŸï¼‰
wrangler d1 execute DB --remote --command "SELECT job_name, started_at, status FROM job_run WHERE started_at >= '2026-01-07T00:00:00Z' ORDER BY started_at DESC;"
```

---

### 8ï¸âƒ£ æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæ—¶é—´

```powershell
# æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
wrangler d1 execute DB --remote --command "SELECT job_name, started_at, finished_at, CAST((julianday(finished_at) - julianday(started_at)) * 86400000 AS INTEGER) as duration_ms FROM job_run WHERE finished_at IS NOT NULL ORDER BY started_at DESC LIMIT 20;"
```

---

## ğŸ“‹ job_run è¡¨ç»“æ„

```sql
CREATE TABLE job_run (
    id TEXT PRIMARY KEY,           -- ä»»åŠ¡ ID (UUID)
    job_name TEXT,                 -- ä»»åŠ¡åç§°
    scheduled_ts TEXT,             -- è®¡åˆ’æ‰§è¡Œæ—¶é—´
    started_at TEXT,               -- å®é™…å¼€å§‹æ—¶é—´
    finished_at TEXT,              -- å®Œæˆæ—¶é—´
    status TEXT,                   -- çŠ¶æ€ï¼špartial/success/fail
    detail TEXT                    -- JSON æ ¼å¼çš„è¯¦ç»†ä¿¡æ¯
);
```

---

## ğŸ¯ å¸¸ç”¨ä»»åŠ¡åç§°

| job_name | è¯´æ˜ | æ‰§è¡Œé¢‘ç‡ |
|----------|------|---------|
| `sample_tiered` | åˆ†å±‚é‡‡æ ·ä»»åŠ¡ | æ¯åˆ†é’Ÿ |
| `update_weapon_tiers` | æ­¦å™¨åˆ†å±‚æ›´æ–° | æ¯å¤© 03:00 |
| `sync_rivens` | å­—å…¸åŒæ­¥ | æ¯å¤© 03:00 |

---
--
**å¿«é€Ÿå¼€å§‹**ï¼šå¤åˆ¶ä¸Šé¢çš„ç¬¬ 2 æ¡å‘½ä»¤ï¼ŒæŸ¥çœ‹æœ€è¿‘çš„åˆ†å±‚é‡‡æ ·ä»»åŠ¡ï¼ğŸ“Š
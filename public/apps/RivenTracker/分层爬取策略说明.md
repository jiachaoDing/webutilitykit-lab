# Riven Tracker 分层爬取策略说明 (V3.0 - DO 协同版)

## 📋 概述

分层爬取策略将 400+ 把武器分为**热门武器 (Hot)** 和 **冷门武器 (Cold)**。在新的 **Durable Object (DO)** 架构下，采样任务实现了“逻辑与状态分离”：Worker 仅负责执行，DO 负责维护游标和决定下一批采样的武器。

---

## 🎯 分层规则

### 武器分层依据
- **热门武器（Hot）**：基于最近 **7 天** 的 `bottom_price` 统计，选取价格最高的前 **50 名**。
- **冷门武器（Cold）**：其余所有已追踪武器。

### 分层更新频率
- **每天 UTC 03:00** 执行一次全量更新。
- 流程：字典同步 -> 价格统计 -> 更新 D1 权重 -> **通知 DO 刷新内存名单**。

---

## ⚡ 采样策略 (由 DO 驱动)

### 采样模式（奇偶分钟交替）
Worker 在每分钟触发时，根据当前分钟数向 DO 请求不同比例的任务：
- **奇数分钟**：请求 **5 把热门** 武器（由 `HOT_BATCH_SIZE_ODD` 配置）。
- **偶数分钟**：请求 **5 把冷门** 武器（由 `COLD_BATCH_SIZE` 配置）。
*注：具体采样比例可在 `wrangler.toml` 中通过环境变量灵活调整。*

### 覆盖周期（按默认 5 把/min 计算）
- **热门武器**（50 把）：**20 分钟** 完成一轮。
- **冷门武器**（350+ 把）：**约 1.2 小时** 完成一轮。

### 核心优势
- ✅ **状态强一致性**：游标存在 DO 内存中，不存在 KV 最终一致性导致的采样重复。
- ✅ **极速响应**：DO 内存计算下一批 slugs 耗时 < 1ms。
- ✅ **动态扩容**：只需修改 Cron 频率或环境变量，DO 会自动适配新的游标进度。

---

## 🏗️ 技术实现 (New!)

### 1. 状态中心：RivenCoordinatorDO
**文件**: `src/apps/RivenTracker/RivenCoordinatorDO.ts`
- 内部维护 `cursorHot` 和 `cursorCold`。
- 接口 `GET /next-batch`：根据传入的 `hotBatchSize` 和 `coldBatchSize` 自动计算并推进游标。
- 接口 `POST /append-results`：接收采样结果，负责**批量写入 D1** 并维护内存快照。

### 2. 采样执行器：SamplingService
**文件**: `src/apps/RivenTracker/services/SamplingService.ts`
- 简化为 `runBatch(slugs, ...)` 方法。
- 不再关心游标和分层逻辑，仅负责并发爬取 WFM API 并计算底价。

### 3. 定时任务集成 (Cron Worker)
**文件**: `src/apps/RivenTracker/jobs/index.ts`

每分钟任务流程：
// 1. 获取 DO 实例
const coordinator = env.RIVEN_COORDINATOR.get(id);

// 2. 向 DO 要任务（DO 内部处理奇偶分钟和游标）
const { slugs } = await coordinator.fetch(`/next-batch?hotBatchSize=5&coldBatchSize=0`);

// 3. 执行采样
const { samples } = await samplingService.runBatch(slugs, windowTs);

// 4. 交回结果（DO 负责写 D1 和更新快照）
await coordinator.fetch("/append-results", { method: "POST", body: samples });---

## 🔧 配置参数

### 环境变量 (`wrangler.toml`)
[vars]
HOT_BATCH_SIZE_ODD = "5"   # 奇数分钟热门采样数
HOT_BATCH_SIZE_EVEN = "0"  # 偶数分钟热门采样数
COLD_BATCH_SIZE = "5"      # 偶数分钟冷门采样数---

## 📊 监控与日志

### Job Run 审计
由于状态移入 DO，`job_run` 表的记录更加精简：
- `sample_tick`：记录每分钟采样的 slugs 列表和成功/失败统计。
- `update_weapon_tiers`：记录每日分层调整的结果。

### 常用查询命令
**查看采样游标进度（通过日志查看）**：
# 查看最近 10 次采样的明细
wrangler d1 execute DB --remote --command "SELECT started_at, status, json_extract(detail, '$.slugs') as slugs FROM job_run WHERE job_name='sample_tick' ORDER BY started_at DESC LIMIT 10;"---

## 🔍 故障排查

### 问题：采样一直停留在某几把武器
- **原因**：DO 内存状态异常或名单未刷新。
- **解决**：调用 `POST /api/RivenTracker/debug/refresh-list` 强制 DO 重新加载 D1 名单并重置游标。

### 问题：冷门武器采样太慢
- **原因**：`COLD_BATCH_SIZE` 设置过小。
- **解决**：调整 `wrangler.toml` 中的配置并重新部署。

---
**最后更新**: 2026-01-09 (DO 架构升级)
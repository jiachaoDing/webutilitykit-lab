## 失败场景与处理策略（Failure Modes）

> 总原则：**单武器失败不影响整批**；**采样幂等**；**对外接口永远可用（最多返回缺失/空点）**；**写 job_run 便于排障**。

| 场景                           | 可能原因                | 检测信号                                       | 处理策略（Worker 内部）                                                    | Tick 落库策略                                                              | 用户侧表现                     |
| ---------------------------- | ------------------- | ------------------------------------------ | ------------------------------------------------------------------ | ---------------------------------------------------------------------- | ------------------------- |
| 1. v1 auctions 接口 429（限流）    | 上游限流；瞬时 QPS 太高      | HTTP 429                                   | 立即降低并发/暂停：退避 2~10s；本 shard 继续但放慢；记录错误计数                            | 写 `source_status="error"`，`error_code="HTTP_429"`，`sample_count=0`（可选） | 趋势出现空点；不影响其它武器            |
| 2. v1 auctions 5xx           | 上游故障/波动             | HTTP 5xx                                   | 单武器重试 1 次（退避 1~3s）；失败则跳过                                           | 同上：error tick 或不写（推荐写 error tick）                                      | 该窗口该武器空点                  |
| 3. v1 auctions 超时            | 网络抖动                | fetch 超时                                   | 1 次重试（更长超时或退避）；失败标记 error                                          | error tick                                                             | 空点                        |
| 4. v1 返回 JSON 结构变化           | 字段改名/嵌套变化           | JSON parse ok，但缺关键字段（如 `payload.auctions`） | 解析层容错：字段缺失→判为“schema_error”；记录 response 的 minimal debug（不存敏感）      | 写 `source_status="error"`，`error_code="SCHEMA_CHANGED"`                | 空点；health 可提示“上游结构变化”     |
| 5. auctions 列表存在但 buyout 为空多 | 竞拍单、非直售             | 过滤后 `prices=[]`                            | 视为 no_data（不是 error）                                               | 写 `source_status="no_data"`，`sample_count=0`                           | 空点；前端显示“样本不足/无 ingame 直售” |
| 6. ingame 样本为 0，但 online 很多  | 市场瞬态/时间段导致          | 过滤 ingame 后 0                              | **坚持策略**：不降级到 online；记录 no_data                                    | 写 no_data tick                                                         | 空点但口径一致（可信）               |
| 7. 异常低价钓鱼污染                  | 极端低价单               | `p1 < 0.6*mean(p2,p3)`                     | 按规则剔除 p1，并尝试补位到 5                                                  | 正常写 tick，并可记录 `detail_flags=["OUTLIER_DROPPED"]`（可选）                   | 趋势更稳定                     |
| 8. tracked 武器列表过大导致单次任务超时    | tracked 太多；响应慢      | job 执行时间过长                                 | 方案 B 已分片；仍超时则：降低本 shard 处理量（分页/限额），剩余下次窗口继续                        | 未处理武器本窗口缺 tick                                                         | 部分武器缺点；health 显示 partial  |
| 9. Cron 重入（同一 shard 重跑）      | Cloudflare 重试；部署；延迟 | 同一 window_ts+shard 被触发多次                   | 锁：KV/D1 lock，已锁则跳过；或允许重复跑（幂等 upsert）                               | UPSERT 覆盖（captured_at 最新）                                              | 无感（稳定）                    |
| 10. D1 写入失败（busy/locked）     | 并发写入/事务冲突           | SQL 执行异常                                   | 写入层重试 1~2 次（短退避）；失败只影响该武器                                          | 若最终失败：不写或写到 job_run 失败列表                                               | 该点缺失                      |
| 11. D1 schema 迁移不兼容          | 新字段/主键变更            | 部署后 SQL 错误                                 | migrations 需向前兼容；启动自检；失败直接报警（job_run fail）                         | 无法写 tick                                                               | API 可能仍可读旧数据，但新数据停更       |
| 12. KV 不可用（可选组件）             | KV 服务异常             | KV get/put 报错                              | KV 失败降级：不缓存、不锁（用 D1 lock 替代或放弃）                                    | 采样仍写 D1                                                                | API 仍可用，性能略降              |
| 13. 字典同步失败（v2 5xx）           | 上游故障                | v2 请求失败                                    | 不影响采样；保留旧字典；job_run 记录 fail                                        | 无 tick 影响                                                              | 武器列表可能不更新                 |
| 14. 武器 slug 与 v1 不匹配         | 字典/接口不一致            | v1 返回空 auctions 或 400                      | 标记该武器 `error_code="INVALID_SLUG"` 并在 tracked 中禁用或降级 priority（可选策略） | no_data 或 error tick                                                   | 某武器永远空点，需运营处理             |
| 15. 前端请求高频导致 D1 压力大          | 热门趋势接口被刷            | API latency 上升                             | KV 缓存 5~10 分钟；或 Cloudflare Cache API；加简单 rate limit（按 IP）          | 不涉及 tick                                                               | 前端响应变慢但可用                 |
| 16. 数据新鲜度下降                  | Cron 未跑/失败          | last_tick_utc 落后                           | health endpoint 提示；job_run 可定位原因                                   | 不涉及                                                                    | 用户看到“最后更新时间过旧”            |
| 17. 时间对齐错误导致趋势抖动             | 用 captured_at 当 ts  | tick.ts 不对齐                                | 强制 window_ts 写入；单元测试校验                                             | 修正后覆盖写入                                                                | 趋势变稳定、点对齐                 |

---

## 额外建议：错误分类与可观测字段（Cursor 实现很加分）

### Tick 推荐增加两个可选字段

* `source_status`: `"ok" | "no_data" | "error"`
* `error_code`: `"HTTP_429" | "HTTP_5XX" | "TIMEOUT" | "SCHEMA_CHANGED" | "INVALID_SLUG" | ...`

### JobRun detail 推荐结构（JSON 字符串）

```json
{
  "window_ts": "2026-01-06T15:30:00Z",
  "shard": 3,
  "total": 28,
  "ok": 20,
  "no_data": 6,
  "error": 2,
  "errors": [
    { "weapon": "xxx", "code": "HTTP_429" }
  ],
  "duration_ms": 18432
}